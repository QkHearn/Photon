name: Multi-Platform Build CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

# 显式声明权限，修复 GITHUB_TOKEN 权限报错
permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: Install Dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libssl-dev nlohmann-json3-dev libgtest-dev lcov

      - name: Install Dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install cmake nlohmann-json openssl googletest lcov

      - name: Setup vcpkg (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          # GitHub Windows runners have vcpkg pre-installed at VCPKG_INSTALLATION_ROOT
          echo "VCPKG_ROOT=$VCPKG_INSTALLATION_ROOT" >> $GITHUB_ENV
          vcpkg integrate install

      - name: Install Dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          vcpkg install nlohmann-json:x64-windows-static openssl:x64-windows-static gtest:x64-windows-static

      - name: Check Tree-sitter config
        id: check_ts
        shell: bash
        run: |
          if [ -f config.json ]; then
            ENABLE_TS=$(python3 -c "import json; f=open('config.json'); d=json.load(f); print('ON' if d.get('agent', {}).get('enable_tree_sitter', False) else 'OFF')" 2>/dev/null || echo "OFF")
          else
            ENABLE_TS="OFF"
          fi
          echo "enable_ts=$ENABLE_TS" >> $GITHUB_OUTPUT
          echo "Tree-sitter will be: $ENABLE_TS"

      - name: Configure and Build (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DPHOTON_ENABLE_TREESITTER=${{ steps.check_ts.outputs.enable_ts }}
          cmake --build . --config Release

      - name: Configure and Build (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          mkdir -p build
          cd build
          # 使用环境变量 VCPKG_ROOT 的正确方式，并用双引号保护路径
          cmake .. -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_TARGET_TRIPLET=x64-windows-static \
            -DPHOTON_ENABLE_TREESITTER=${{ steps.check_ts.outputs.enable_ts }}
          cmake --build . --config Release

      - name: Run Unit Tests
        shell: bash
        run: |
          cd build
          # 增强的测试查找逻辑，覆盖 Unix 和 Windows 路径
          TEST_EXE=""
          for f in agent_tests agent_tests.exe Release/agent_tests.exe Debug/agent_tests.exe; do
            if [ -f "$f" ]; then TEST_EXE="$f"; break; fi
          done
          
          if [ -n "$TEST_EXE" ]; then
            echo "Running unit tests: $TEST_EXE"
            ctest --output-on-failure -V -C Release
          else
            echo "⚠️ Test executable not found. Skipping tests."
          fi

      - name: Archive Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: photon-${{ matrix.os }}
          path: |
            build/photon
            build/photon.exe
            build/Release/photon.exe
          if-no-files-found: warn

  test-and-coverage:
    name: Unit Tests & Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libssl-dev nlohmann-json3-dev libgtest-dev lcov gcov

      - name: Configure CMake with Coverage
        run: |
          mkdir -p build-coverage
          cd build-coverage
          # 覆盖率测试通常在 Debug 模式下运行，且关闭 Tree-sitter 以减少环境干扰
          cmake .. -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON -DPHOTON_ENABLE_TREESITTER=OFF
          cmake --build . --config Debug

      - name: Run Unit Tests
        run: |
          cd build-coverage
          ctest --output-on-failure -V

      - name: Generate Coverage Report
        run: |
          cd build-coverage
          # 收集数据并排除无关目录
          lcov --capture --directory . --output-file coverage.info \
            --exclude '/usr/*' \
            --exclude '*/third_party/*' \
            --exclude '*/build*' \
            --exclude '*/tests/*'
          # 生成 HTML 报告
          genhtml coverage.info --output-directory coverage-report --show-details
          # 打印摘要
          lcov --summary coverage.info

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build-coverage/coverage-report
          if-no-files-found: warn

      - name: Upload Coverage to Codecov (Optional)
        if: github.event_name == 'pull_request'
        uses: codecov/codecov-action@v4
        with:
          file: ./build-coverage/coverage.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
