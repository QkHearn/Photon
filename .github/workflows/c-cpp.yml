name: Multi-Platform Build CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: Install Dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libssl-dev nlohmann-json3-dev libgtest-dev lcov

      - name: Install Dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install cmake nlohmann-json openssl googletest lcov

      - name: Setup vcpkg (Windows)
        if: matrix.os == 'windows-latest'
        uses: microsoft/setup-vcpkg@v3
        with:
          vcpkgGitCommitSha: "HEAD"

      - name: Install Dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          vcpkg install nlohmann-json:x64-windows-static openssl:x64-windows-static gtest:x64-windows-static

      - name: Check Tree-sitter config
        id: check_ts
        run: |
          if [ -f config.json ]; then
            ENABLE_TS=$(python3 -c "import json; f=open('config.json'); d=json.load(f); print('ON' if d.get('agent', {}).get('enable_tree_sitter', False) else 'OFF')" 2>/dev/null || echo "OFF")
          else
            ENABLE_TS="OFF"
          fi
          echo "enable_ts=$ENABLE_TS" >> $GITHUB_OUTPUT
          echo "Tree-sitter will be: $ENABLE_TS"

      - name: Configure and Build (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DPHOTON_ENABLE_TREESITTER=${{ steps.check_ts.outputs.enable_ts }}
          cmake --build . --config Release

      - name: Check Tree-sitter config (Windows)
        if: matrix.os == 'windows-latest'
        id: check_ts_win
        shell: bash
        run: |
          if [ -f config.json ]; then
            ENABLE_TS=$(python3 -c "import json; f=open('config.json'); d=json.load(f); print('ON' if d.get('agent', {}).get('enable_tree_sitter', False) else 'OFF')" 2>/dev/null || echo "OFF")
          else
            ENABLE_TS="OFF"
          fi
          echo "enable_ts=$ENABLE_TS" >> $GITHUB_OUTPUT
          echo "Tree-sitter will be: $ENABLE_TS"

      - name: Configure and Build (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows-static -DPHOTON_ENABLE_TREESITTER=${{ steps.check_ts_win.outputs.enable_ts }}
          cmake --build . --config Release

      - name: Run Unit Tests
        run: |
          cd build
          # Windows 上测试可执行文件可能在 Release 或 Debug 目录
          TEST_EXE=""
          if [ -f agent_tests ]; then
            TEST_EXE="agent_tests"
          elif [ -f agent_tests.exe ]; then
            TEST_EXE="agent_tests.exe"
          elif [ -f Release/agent_tests.exe ]; then
            TEST_EXE="Release/agent_tests.exe"
          elif [ -f Debug/agent_tests.exe ]; then
            TEST_EXE="Debug/agent_tests.exe"
          fi

          if [ -n "$TEST_EXE" ]; then
            echo "Running unit tests: $TEST_EXE"
            ctest --output-on-failure -V
            TEST_RESULT=$?
            if [ $TEST_RESULT -ne 0 ]; then
              echo "❌ Unit tests failed"
              exit $TEST_RESULT
            fi
            echo "✅ All unit tests passed"
          else
            echo "⚠️  Test executable not found. Searched: agent_tests, agent_tests.exe, Release/agent_tests.exe, Debug/agent_tests.exe"
            echo "    Build may have succeeded but tests were not built."
          fi

      - name: Archive Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: photon-${{ matrix.os }}
          path: |
            build/photon
            build/photon.exe
            build/Release/photon.exe
          if-no-files-found: warn

  # Separate job for unit tests and code coverage (Linux only for coverage)
  test-and-coverage:
    name: Unit Tests & Code Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libssl-dev nlohmann-json3-dev libgtest-dev lcov gcov

      - name: Check Tree-sitter config
        id: check_ts
        run: |
          if [ -f config.json ]; then
            ENABLE_TS=$(python3 -c "import json; f=open('config.json'); d=json.load(f); print('ON' if d.get('agent', {}).get('enable_tree_sitter', False) else 'OFF')" 2>/dev/null || echo "OFF")
          else
            ENABLE_TS="OFF"
          fi
          echo "enable_ts=$ENABLE_TS" >> $GITHUB_OUTPUT
          echo "Tree-sitter will be: $ENABLE_TS"

      - name: Configure CMake with Coverage
        run: |
          mkdir -p build-coverage
          cd build-coverage
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DPHOTON_ENABLE_TREESITTER=${{ steps.check_ts.outputs.enable_ts }} \
            -DENABLE_COVERAGE=ON

      - name: Build with Coverage
        run: |
          cd build-coverage
          cmake --build . --config Debug

      - name: Run Unit Tests
        run: |
          cd build-coverage
          ctest --output-on-failure -V
          TEST_RESULT=$?
          if [ $TEST_RESULT -ne 0 ]; then
            echo "❌ Unit tests failed"
            exit $TEST_RESULT
          fi
          echo "✅ All unit tests passed"

      - name: Generate Coverage Report
        run: |
          cd build-coverage
          # Collect coverage data
          lcov --capture --directory . --output-file coverage.info --exclude '/usr/*' --exclude '*/third_party/*' --exclude '*/build*' --exclude '*/tests/*'
          # Generate HTML report
          genhtml coverage.info --output-directory coverage-report --show-details
          # Print summary
          lcov --summary coverage.info

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build-coverage/coverage-report
          if-no-files-found: warn

      - name: Upload Coverage to Codecov (Optional)
        if: github.event_name == 'pull_request'
        uses: codecov/codecov-action@v4
        with:
          file: ./build-coverage/coverage.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
