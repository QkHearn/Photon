# Photon é¡¹ç›®è®¾è®¡æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

**Photon** æ˜¯ä¸€ä¸ªåŸç”Ÿ C++æ„å»ºçš„ AI Agent æ ¸å¿ƒå¼•æ“ï¼Œä¸“ä¸ºå·¥ç¨‹ç²¾åº¦è€Œè®¾è®¡ã€‚ä¸ä¾èµ–"æ¨¡ç³Š"æ–‡æœ¬æœç´¢çš„é€šç”¨ AI Agent ä¸åŒï¼ŒPhoton é€šè¿‡ AST è§£æå’Œ LSP é›†æˆæä¾›ç¼–è¯‘å™¨çº§åˆ«çš„ä»£ç ç†è§£èƒ½åŠ›ã€‚

### æ ¸å¿ƒä»·å€¼ä¸»å¼ 

- **é›¶å»¶è¿Ÿæ€§èƒ½**ï¼šå¾®ç§’çº§å·¥å…·é“¾è°ƒç”¨ï¼Œ10-30MB å†…å­˜å ç”¨
- **å¤–ç§‘çº§ç²¾åº¦**ï¼šTree-sitter å®æ—¶ AST è§£æ + LSP æ·±åº¦é›†æˆ
- **æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šç»“æ„åŒ–æ‘˜è¦ + çª—å£åŒ–è¯»å–ï¼Œé¿å… token æµªè´¹
- **å®‰å…¨ç¬¬ä¸€**ï¼šäººæœºäº¤äº’ç¡®è®¤é«˜é£é™©æ“ä½œï¼Œç¡®å®šæ€§å›æ»šæœºåˆ¶

## 2. æ•´ä½“æ¶æ„è®¾è®¡

### 2.1 ç³»ç»Ÿæ¶æ„å›¾

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚           IDE / Terminal Host            â”‚
                     â”‚ (VS Code, JetBrains, Cursor, Vim, etc.)  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚ (Standard I/O)
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚            PHOTON KERNEL (C++)           â”‚
                     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
                     â”‚  [ Context Manager ]    [ Memory System ]â”‚
                     â”‚  (Short-term Mem)       (JSON/Markdown)  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     LLM Client     â”‚    â”‚  MCP Tool Manager   â”‚
                    â”‚   (Reasoning Hub)  â”‚    â”‚   (Execution Hub)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                    â”‚                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Built-in Tools   â”‚               â”‚   Expert Skills    â”‚            â”‚    External MCP    â”‚
â”‚    (C++ Native)    â”‚               â”‚  (Modular Logic)   â”‚            â”‚   (Node / Python)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚â€¢ Parallel Search   â”‚               â”‚â€¢ Code Architect    â”‚            â”‚â€¢ Puppeteer         â”‚
â”‚â€¢ AST Analysis      â”‚               â”‚â€¢ Debug Master      â”‚            â”‚â€¢ Google Search     â”‚
â”‚â€¢ Python Sandbox    â”‚               â”‚â€¢ Env Initializer   â”‚            â”‚â€¢ Custom Servers    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ¨¡å—åˆ’åˆ†

#### 2.2.1 æ ¸å¿ƒå¼•æ“å±‚ (Core Engine)

- **main.cpp**ï¼šåº”ç”¨å…¥å£ï¼Œä¸»äº‹ä»¶å¾ªç¯
- **ContextManager**ï¼šä¸Šä¸‹æ–‡å‹ç¼©å’Œç®¡ç†
- **LLMClient**ï¼šLLM API å®¢æˆ·ç«¯å°è£…
- **UIManager**ï¼šç”¨æˆ·ç•Œé¢ç®¡ç†ï¼ˆCLI æ¨¡å¼ï¼‰

#### 2.2.2 MCP é›†æˆå±‚ (MCP Integration)

- **MCPClient**ï¼šModel Context Protocol å®¢æˆ·ç«¯
- **MCPManager**ï¼šMCP æœåŠ¡å™¨ç®¡ç†å™¨
- **LSPClient**ï¼šLanguage Server Protocol å®¢æˆ·ç«¯
- **InternalMCPClient**ï¼šå†…ç½®å·¥å…·å®ç°

#### 2.2.3 å·¥å…·ä¸æŠ€èƒ½å±‚ (Tools & Skills)

- **SymbolManager**ï¼šç¬¦å·ç´¢å¼•å’Œç®¡ç†
- **SemanticManager**ï¼šè¯­ä¹‰ç´¢å¼•å’Œå‘é‡æœç´¢
- **SkillManager**ï¼šä¸“å®¶æŠ€èƒ½åŠ è½½å’Œç®¡ç†
- **FileManager**ï¼šæ–‡ä»¶ç³»ç»Ÿæ“ä½œ

#### 2.2.4 åˆ†ææä¾›å±‚ (Analysis Providers)

- **RegexSymbolProvider**ï¼šåŸºäºæ­£åˆ™çš„ç¬¦å·æå–
- **TreeSitterSymbolProvider**ï¼šåŸºäº AST çš„ç¬¦å·æå–
- **BuiltinSkillsData**ï¼šå†…ç½®æŠ€èƒ½æ•°æ®

## 3. è¯¦ç»†æ¨¡å—è®¾è®¡

### 3.1 æ ¸å¿ƒå¼•æ“æ¨¡å—

#### 3.1.1 ContextManager

```cpp
class ContextManager {
    // ç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæ™ºèƒ½å‹ç¼©è¶…é•¿çš„æ¶ˆæ¯å†å²
    // é˜ˆå€¼è§¦å‘æœºåˆ¶ï¼Œä¿æŒtokenä½¿ç”¨æ•ˆç‡
    size_t threshold;  // é»˜è®¤50000å­—ç¬¦
    nlohmann::json manage(const nlohmann::json& messages);
    nlohmann::json forceCompress(const nlohmann::json& messages);
};
```

**è®¾è®¡è¦ç‚¹**ï¼š

- é€’å½’æ‘˜è¦å‹ç¼©ç®—æ³•
- ä¿ç•™å…³é”®å†³ç­–ç‚¹å’Œé€»è¾‘é“¾
- æ”¯æŒå¼ºåˆ¶å‹ç¼©ç”¨æˆ·å‘½ä»¤

#### 3.1.2 LLMClient

```cpp
class LLMClient {
    // å°è£…å¤šç§LLM APIè°ƒç”¨
    // æ”¯æŒå·¥å…·è°ƒç”¨å’Œæ¶ˆæ¯è§„èŒƒåŒ–
    nlohmann::json chatWithTools(const nlohmann::json& messages, const nlohmann::json& tools);
    std::string summarize(const std::string& text);
    std::vector<float> getEmbedding(const std::string& text);
};
```

**è®¾è®¡è¦ç‚¹**ï¼š

- Kimi API é€‚é…å™¨ï¼ˆæ¶ˆæ¯æ ¼å¼è§„èŒƒåŒ–ï¼‰
- æ”¯æŒå¤šç§ LLM æä¾›å•†
- åµŒå…¥å‘é‡ç”Ÿæˆç”¨äºè¯­ä¹‰æœç´¢

### 3.2 MCP é›†æˆæ¨¡å—

#### 3.2.1 MCPClient

```cpp
class MCPClient : public IMCPClient {
    // å¤–éƒ¨MCPæœåŠ¡å™¨å®¢æˆ·ç«¯
    // è¿›ç¨‹é—´é€šä¿¡ç®¡ç†
    std::string serverCommand;
    int readPipe[2], writePipe[2];
    pid_t childPid;
    nlohmann::json sendRequest(const std::string& method, const nlohmann::json& params);
};
```

**è®¾è®¡è¦ç‚¹**ï¼š

- å­è¿›ç¨‹ç®¡ç†ï¼Œæ”¯æŒè·¨å¹³å°
- JSON-RPC åè®®å®ç°
- é”™è¯¯å¤„ç†å’Œé‡è¿æœºåˆ¶

#### 3.2.2 LSPClient

```cpp
class LSPClient {
    // è¯­è¨€æœåŠ¡å™¨å®¢æˆ·ç«¯
    // æä¾›ä»£ç å¯¼èˆªå’Œåˆ†æèƒ½åŠ›
    std::vector<Location> goToDefinition(const std::string& fileUri, const Position& position);
    std::vector<Location> findReferences(const std::string& fileUri, const Position& position);
    std::vector<DocumentSymbol> documentSymbols(const std::string& fileUri);
};
```

**è®¾è®¡è¦ç‚¹**ï¼š

- å¤šè¯­è¨€æ”¯æŒï¼ˆC++, Python, TypeScript, ArkTS ç­‰ï¼‰
- è‡ªåŠ¨æ£€æµ‹å’Œåˆå§‹åŒ– LSP æœåŠ¡å™¨
- å¹¶è¡Œåˆå§‹åŒ–ä¼˜åŒ–

### 3.3 ç¬¦å·ç®¡ç†æ¨¡å—

#### 3.3.1 SymbolManager

```cpp
class SymbolManager {
    // ç»Ÿä¸€çš„ç¬¦å·ç´¢å¼•å’Œç®¡ç†
    // æ”¯æŒå¤šç§ç¬¦å·æä¾›è€…å’Œå®æ—¶æ›´æ–°
    std::vector<std::unique_ptr<ISymbolProvider>> providers;
    std::unordered_map<std::string, std::vector<Symbol>> fileSymbols;

    void startAsyncScan();           // å¼‚æ­¥å…¨é‡æ‰«æ
    void startWatching(int intervalSeconds = 5);  // å®æ—¶æ–‡ä»¶ç›‘æ§
    std::vector<Symbol> search(const std::string& query);
    std::optional<Symbol> findEnclosingSymbol(const std::string& relPath, int line);
};
```

**è®¾è®¡è¦ç‚¹**ï¼š

- æ’ä»¶å¼ç¬¦å·æä¾›è€…æ¶æ„
- æ–‡ä»¶å˜æ›´æ£€æµ‹å’Œå¢é‡æ›´æ–°
- è°ƒç”¨å›¾æ„å»ºå’Œåˆ†æ

#### 3.3.2 ç¬¦å·æä¾›è€…æ¥å£

```cpp
class ISymbolProvider {
    // ç¬¦å·æå–æŠ½è±¡æ¥å£
    virtual std::vector<Symbol> extractSymbols(const std::string& content, const std::string& relPath) const = 0;
    virtual bool supportsExtension(const std::string& ext) const = 0;
};
```

**å®ç°ç±»**ï¼š

- **RegexSymbolProvider**ï¼šåŸºäºæ­£åˆ™è¡¨è¾¾å¼ï¼Œé€šç”¨æ€§å¼º
- **TreeSitterSymbolProvider**ï¼šåŸºäº ASTï¼Œç²¾åº¦é«˜ï¼Œæ”¯æŒå¤šè¯­è¨€

### 3.4 è¯­ä¹‰ç®¡ç†æ¨¡å—

#### 3.4.1 SemanticManager

```cpp
class SemanticManager {
    // è¯­ä¹‰ç´¢å¼•å’Œå‘é‡æœç´¢
    // æ”¯æŒä»£ç å’Œæ–‡æ¡£çš„è¯­ä¹‰ç†è§£
    std::vector<SemanticChunk> chunks;
    std::shared_ptr<LLMClient> llmClient;

    void addChunk(const SemanticChunk& chunk);
    std::vector<SemanticChunk> search(const std::string& query, int topK = 5);
    void startAsyncIndexing();  // åå°ç´¢å¼•æ„å»º
};
```

**è®¾è®¡è¦ç‚¹**ï¼š

- å‘é‡åµŒå…¥å’Œä½™å¼¦ç›¸ä¼¼åº¦æœç´¢
- SQLite æŒä¹…åŒ–å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
- å¤šç§å†…å®¹ç±»å‹æ”¯æŒï¼ˆä»£ç ã€Markdownã€äº‹å®ã€æŠ€èƒ½ï¼‰

### 3.5 æŠ€èƒ½ç®¡ç†æ¨¡å—

#### 3.5.1 SkillManager

```cpp
class SkillManager {
    // ä¸“å®¶æŠ€èƒ½åŠ è½½å’Œç®¡ç†
    // æ”¯æŒå†…ç½®æŠ€èƒ½å’Œå¤–éƒ¨æŠ€èƒ½
    struct Skill {
        std::string name;
        std::string description;
        std::string content;
        std::string path;
        bool isBuiltin = false;
    };

    void loadInternalStaticSkills();  // åŠ è½½å†…ç½®æŠ€èƒ½
    void syncAndLoad(const std::vector<std::string>& sourceRoots, const std::string& globalDataPath);
    std::string getSystemPromptAddition() const;
};
```

**è®¾è®¡è¦ç‚¹**ï¼š

- YAML frontmatter è§£æ
- å¢é‡åŒæ­¥æœºåˆ¶
- æŠ€èƒ½ä¼˜å…ˆçº§ç®¡ç†

## 4. å†…ç½®å·¥å…·è®¾è®¡

### 4.1 å·¥å…·åˆ†ç±»

#### 4.1.1 æ–‡ä»¶ç³»ç»Ÿå·¥å…·

- **file_read**ï¼šæ™ºèƒ½æ–‡ä»¶è¯»å–ï¼ˆæ”¯æŒç¬¦å·ã€èŒƒå›´ã€ä¸Šä¸‹æ–‡çª—å£æ¨¡å¼ï¼‰
- **file_write**ï¼šå¤–ç§‘çº§æ–‡ä»¶å†™å…¥ï¼ˆè¡Œçº§ç¼–è¾‘ï¼Œç¦æ­¢å…¨æ–‡ä»¶è¦†ç›–ï¼‰
- **file_search**ï¼šå¤šæ¨¡å¼æ–‡ä»¶æœç´¢ï¼ˆæ–‡æœ¬ã€æ­£åˆ™ã€è¯­ä¹‰ï¼‰
- **list_dir_tree**ï¼šç›®å½•ç»“æ„æµè§ˆ

#### 4.1.2 ä»£ç åˆ†æå·¥å…·

- **lsp_definition**ï¼šè·³è½¬åˆ°å®šä¹‰
- **lsp_references**ï¼šæŸ¥æ‰¾å¼•ç”¨
- **symbol_search**ï¼šç¬¦å·æœç´¢
- **diagnostics_check**ï¼šè¯Šæ–­æ£€æŸ¥

#### 4.1.3 ç³»ç»Ÿå·¥å…·

- **bash_execute**ï¼šå‘½ä»¤æ‰§è¡Œï¼ˆé˜»æ­¢è¯»å–å‘½ä»¤é¿å…å¾ªç¯ï¼‰
- **git_operations**ï¼šGit ç‰ˆæœ¬æ§åˆ¶
- **python_sandbox**ï¼šPython ä»£ç æ²™ç®±æ‰§è¡Œ
- **memory**ï¼šé•¿æœŸè®°å¿†ç®¡ç†

### 4.2 å®‰å…¨æœºåˆ¶

#### 4.2.1 äººæœºäº¤äº’ç¡®è®¤

```cpp
bool isRiskyTool(const std::string& toolName) {
    static const std::unordered_set<std::string> risky = {
        "write", "file_write", "file_create", "file_edit_lines", "edit_batch_lines",
        "bash_execute", "git_operations", "python_sandbox", "pip_install", "schedule"
    };
    return risky.count(toolName) > 0;
}
```

#### 4.2.2 è¯»å–ä¿æŠ¤æœºåˆ¶

- é˜»æ­¢ bash è¯»å–å‘½ä»¤ï¼ˆcat, head, tail ç­‰ï¼‰
- å¼ºåˆ¶ä½¿ç”¨ä¸“ç”¨è¯»å–å·¥å…·
- æœç´¢å¾ªç¯æ£€æµ‹å’Œé¢„é˜²

## 5. é…ç½®ç³»ç»Ÿè®¾è®¡

### 5.1 é…ç½®æ–‡ä»¶ç»“æ„

```json
{
  "llm": {
    "api_key": "",
    "base_url": "https://api.moonshot.cn/v1",
    "model": "kimi-k2-0905-preview",
    "system_role": "You are Photon..."
  },
  "agent": {
    "context_threshold": 50000,
    "file_extensions": [".cpp", ".h", ".py", ".md", ".json"],
    "use_builtin_tools": true,
    "enable_tree_sitter": true,
    "lsp_servers": [],
    "tree_sitter_languages": [],
    "skill_roots": []
  },
  "mcp_servers": [
    {
      "name": "puppeteer",
      "command": "npx -y @modelcontextprotocol/server-puppeteer"
    }
  ]
}
```

### 5.2 æ™ºèƒ½é…ç½®

- LSP æœåŠ¡å™¨è‡ªåŠ¨æ£€æµ‹
- Tree-sitter æ ¹æ®é…ç½®åŠ¨æ€å¯ç”¨
- æŠ€èƒ½æ ¹ç›®å½•è‡ªåŠ¨å‘ç°

## 6. æ„å»ºç³»ç»Ÿè®¾è®¡

### 6.1 CMake æ„å»º

- **è·¨å¹³å°æ”¯æŒ**ï¼šWindowsã€macOSã€Linux
- **ä¾èµ–ç®¡ç†**ï¼šnlohmann-jsonã€OpenSSLã€FTXUI
- **å¯é€‰ç»„ä»¶**ï¼šTree-sitterã€SQLiteã€GTest
- **ä»£ç è¦†ç›–ç‡**ï¼šå¯é€‰å¯ç”¨

### 6.2 æ„å»ºè„šæœ¬

- **build.sh**ï¼šæ™ºèƒ½æ„å»ºè„šæœ¬
- è‡ªåŠ¨æ£€æµ‹ Tree-sitter é…ç½®
- CMake å’Œæ‰‹åŠ¨ç¼–è¯‘åŒè·¯å¾„
- å¹³å°ç‰¹å®šä¼˜åŒ–

### 6.3 CI/CD æµç¨‹

- **å¤šå¹³å°æ„å»º**ï¼šUbuntuã€macOSã€Windows
- **ä¾èµ–å®‰è£…**ï¼šå¹³å°ç‰¹å®šåŒ…ç®¡ç†å™¨
- **å•å…ƒæµ‹è¯•**ï¼šè‡ªåŠ¨æ‰§è¡Œå’Œè¦†ç›–ç‡æŠ¥å‘Š
- **åˆ¶å“å½’æ¡£**ï¼šæ„å»ºäº§ç‰©è‡ªåŠ¨ä¸Šä¼ 

## 7. æ‰©å±•æ€§è®¾è®¡

### 7.1 MCP åè®®æ”¯æŒ

- å¤–éƒ¨ MCP æœåŠ¡å™¨å³æ’å³ç”¨
- å·¥å…·è‡ªåŠ¨å‘ç°å’Œé›†æˆ
- ç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼å’Œé”™è¯¯å¤„ç†

### 7.2 æŠ€èƒ½ç³»ç»Ÿ

- **æ¨¡å—åŒ–è®¾è®¡**ï¼šSKILL.md è‡ªæè¿°
- **åŠ¨æ€åŠ è½½**ï¼šè¿è¡Œæ—¶æŠ€èƒ½å‘ç°
- **å±‚æ¬¡åŒ–ç»„ç»‡**ï¼šå†…ç½®ã€é¡¹ç›®ã€ç”¨æˆ·çº§åˆ«

### 7.3 ç¬¦å·æä¾›è€…

- æ’ä»¶å¼æ¶æ„
- å¤šè¯­è¨€æ”¯æŒ
- ç²¾åº¦å¯é…ç½®

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 å¼‚æ­¥å¤„ç†

- ç¬¦å·æ‰«æå¼‚æ­¥åŒ–
- LSP å®¢æˆ·ç«¯å¹¶è¡Œåˆå§‹åŒ–
- MCP æœåŠ¡å™¨å¹¶å‘å¯åŠ¨

### 8.2 ç¼“å­˜ç­–ç•¥

- ç¬¦å·ç´¢å¼•æŒä¹…åŒ–
- è¯­ä¹‰å‘é‡ç¼“å­˜
- æ–‡ä»¶å˜æ›´å¢é‡æ›´æ–°

### 8.3 å†…å­˜ç®¡ç†

- æ™ºèƒ½æŒ‡é’ˆå¹¿æ³›ä½¿ç”¨
- å¤§æ–‡ä»¶åˆ†å—å¤„ç†
- ä¸Šä¸‹æ–‡å‹ç¼©ç®—æ³•

## 9. é”™è¯¯å¤„ç†å’Œç›‘æ§

### 9.1 å¼‚å¸¸å¤„ç†

- å…¨å±€å¼‚å¸¸å¤„ç†å™¨
- å·¥å…·è°ƒç”¨é”™è¯¯éš”ç¦»
- ä¼˜é›…é™çº§æœºåˆ¶

### 9.2 æ—¥å¿—ç³»ç»Ÿ

- åˆ†çº§æ—¥å¿—è®°å½•
- ç»“æ„åŒ–é”™è¯¯ä¿¡æ¯
- è°ƒè¯•ä¿¡æ¯è¯¦ç»†è®°å½•

### 9.3 æ¢å¤æœºåˆ¶

- Git å›é€€æ”¯æŒ
- æ–‡ä»¶å¤‡ä»½ç³»ç»Ÿ
- æ“ä½œå†å²è¿½è¸ª

## 10. æœªæ¥æ‰©å±•æ–¹å‘

### 10.1 æ¶æ„æ¼”è¿›

- æ’ä»¶ç³»ç»Ÿå®Œå–„
- åˆ†å¸ƒå¼æ”¯æŒ
- äº‘åŸç”Ÿé€‚é…

### 10.2 åŠŸèƒ½å¢å¼º

- æ›´å¤šè¯­è¨€æ”¯æŒ
- é«˜çº§é‡æ„èƒ½åŠ›
- æ™ºèƒ½ä»£ç ç”Ÿæˆ

### 10.3 æ€§èƒ½æå‡

- å¢é‡ç¼–è¯‘é›†æˆ
- å¹¶è¡Œå¤„ç†ä¼˜åŒ–
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–

---

## **æ–‡æ¡£è¯´æ˜**ï¼šæœ¬è®¾è®¡æ–‡æ¡£åŸºäºå¯¹ Photon é¡¹ç›®ä»£ç çš„è¯¦ç»†èµ°è¯»åˆ†æï¼Œæ¶µç›–äº†ç³»ç»Ÿæ¶æ„ã€æ ¸å¿ƒæ¨¡å—ã€å·¥å…·è®¾è®¡ã€å®‰å…¨æœºåˆ¶ç­‰å„ä¸ªæ–¹é¢ï¼Œä¸ºåç»­é‡æ„å’Œä¼˜åŒ–æä¾›å®Œæ•´çš„æŠ€æœ¯å‚è€ƒã€‚

# é‡æ„æŒ‡å¯¼ï¼ˆåŸºäºæç®€å·¥ä¸šçº§è¾…åŠ©ç¼–ç¨‹æ™ºèƒ½ä½“ç™½çš®ä¹¦ï¼‰

> ç›®æ ‡ï¼šåœ¨ **ä¸æ¨ç¿»ç°æœ‰ C++ å·¥ç¨‹** çš„å‰æä¸‹ï¼Œå°†å½“å‰é¡¹ç›®é‡æ„ä¸º  
> **ä½ä¸Šä¸‹æ–‡å ç”¨ / åŸå­å·¥å…·é©±åŠ¨ / å¼ºç¯å¢ƒæ„ŸçŸ¥ / å¯å·¥ä¸šåŒ–æ¼”è¿›** çš„è¾…åŠ©ç¼–ç¨‹æ™ºèƒ½ä½“æ ¸å¿ƒã€‚

---

## ä¸€ã€ç°æœ‰ç›®å½•çš„æ€»ä½“è¯„ä»·

ä½ å½“å‰çš„ç»“æ„ **ä¸æ˜¯å·®ï¼Œè€Œæ˜¯â€œåŠŸèƒ½æ­£ç¡®ä½†è¾¹ç•Œæ¨¡ç³Šâ€**ï¼š

ä¼˜ç‚¹ï¼š

- å·²æœ‰æ˜ç¡®æ¨¡å—ï¼šContext / MCP / Skill / Symbol / LSP
- å·²åœ¨å®è·µã€Œå·¥å…·åŒ– + æ™ºèƒ½ä½“ã€æ–¹å‘
- éå¸¸æ¥è¿‘å·¥ä¸šçº§æ¶æ„é›å½¢

æ ¸å¿ƒé—®é¢˜ï¼ˆé‡æ„åŠ¨æœºï¼‰ï¼š

1. âŒ **å†³ç­–å±‚ä¸æ‰§è¡Œå±‚è€¦åˆ**
2. âŒ ContextManager æ‰¿æ‹…äº†è¿‡å¤šâ€œæ™ºèƒ½åˆ¤æ–­â€
3. âŒ MCP / Skill / å†…éƒ¨èƒ½åŠ›è¾¹ç•Œä¸æ¸…
4. âŒ LLMClient æ—¢åƒâ€œå¤§è„‘â€åˆåƒâ€œIOâ€
5. âŒ ç¼ºå°‘ä¸€ä¸ªçœŸæ­£çš„ã€ŒAgent Runtimeã€

---

## äºŒã€é‡æ„çš„æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼ˆè¯·ä¸¥æ ¼éµå®ˆï¼‰

### 1ï¸âƒ£ å¤§æ¨¡å‹æ°¸è¿œä¸ç›´æ¥ï¼š

- è¯»æ–‡ä»¶
- å†™æ–‡ä»¶
- æœç´¢ç›®å½•
- è°ƒç”¨ MCP / LSP

ğŸ‘‰ **åªèƒ½é€šè¿‡ Tool æ¥å£**

---

### 2ï¸âƒ£ å·¥å…·å¿…é¡»æ˜¯â€œåŸå­â€çš„

é”™è¯¯ç¤ºä¾‹ï¼š

> read_and_summarize_file

æ­£ç¡®ç¤ºä¾‹ï¼š

- read_file_range(path, start, end)
- list_dir(path)
- write_file_patch(path, start, end, content)

---

### 3ï¸âƒ£ è®°å¿†ä¸æ˜¯ä¸Šä¸‹æ–‡ï¼Œæ˜¯ç»“æ„åŒ–èµ„äº§

Context â‰  Memory  
Memory â‰  Chat History

---

## ä¸‰ã€æ¨èçš„é‡æ„åç›®å½•ç»“æ„ï¼ˆæ˜ å°„ä½ çš„ç°æœ‰ä»£ç ï¼‰

```txt
src/
â”œâ”€â”€ main.cpp                # å¯åŠ¨å…¥å£ï¼ˆåªåš wiringï¼‰
â”‚
â”œâ”€â”€ agent/
â”‚   â”œâ”€â”€ AgentRuntime.h/cpp  # â­ æ–°å¢ï¼šæ™ºèƒ½ä½“ä¸»å¾ªç¯ï¼ˆPlan â†’ Act â†’ Observeï¼‰
â”‚   â”œâ”€â”€ AgentState.h        # å½“å‰ä»»åŠ¡ã€é˜¶æ®µã€ç›®æ ‡
â”‚   â””â”€â”€ AgentPlanner.h     # LLM è¾“å‡ºè§£æï¼ˆPlan / ToolCall / Decisionï¼‰
â”‚
â”œâ”€â”€ llm/
â”‚   â”œâ”€â”€ LLMClient.h/cpp     # åªè´Ÿè´£æ¨¡å‹é€šä¿¡ï¼ˆæ— ä»»ä½•ä¸šåŠ¡ï¼‰
â”‚   â””â”€â”€ PromptAssembler.h  # Prompt æ‹¼è£…ï¼ˆRole / Task / State / ToolDescï¼‰
â”‚
â”œâ”€â”€ context/
â”‚   â”œâ”€â”€ ContextManager.h/cpp   # â—ç˜¦èº«ï¼šåªè´Ÿè´£ä¸Šä¸‹æ–‡è£å‰ªä¸æ‹¼è£…
â”‚   â””â”€â”€ ContextPolicy.h        # Token / ä¼˜å…ˆçº§ / ä¸¢å¼ƒè§„åˆ™
â”‚
â”œâ”€â”€ memory/
â”‚   â”œâ”€â”€ MemoryManager.h        # â­ æ–°å¢ï¼šè®°å¿†ç»Ÿä¸€å…¥å£
â”‚   â”œâ”€â”€ ProjectMemory.h        # æ¶æ„ã€çº¦å®šã€ç›®å½•è¯´æ˜
â”‚   â”œâ”€â”€ UserPreference.h       # é£æ ¼ã€åå¥½
â”‚   â””â”€â”€ FailureMemory.h        # é”™è¯¯ â†’ è§£å†³æ–¹æ¡ˆ
â”‚
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ ToolRegistry.h         # â­ æ‰€æœ‰å·¥å…·çš„æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ FileTools.cpp/h        # read / write / list
â”‚   â”œâ”€â”€ BuildTools.cpp/h       # build / test / run
â”‚   â””â”€â”€ EnvTools.cpp/h         # clang, cmake, git æ¢æµ‹
â”‚
â”œâ”€â”€ mcp/
â”‚   â”œâ”€â”€ MCPClient.h/cpp        # ä¿ç•™
â”‚   â”œâ”€â”€ MCPManager.h           # ä½œä¸º Tool Provider å­˜åœ¨
â”‚
â”œâ”€â”€ skills/
â”‚   â”œâ”€â”€ SkillManager.h         # â—ä¸ç›´æ¥æ‰§è¡Œï¼Œåªäº§å‡º Tool Plan
â”‚   â””â”€â”€ BuiltinSkillsData.h
â”‚
â”œâ”€â”€ analysis/
â”‚   â”œâ”€â”€ SymbolManager.h/cpp    # ä¿ç•™
â”‚   â”œâ”€â”€ SemanticManager.h/cpp  # ä¿ç•™
â”‚   â””â”€â”€ LSPClient.h/cpp
â”‚
â””â”€â”€ infra/
    â”œâ”€â”€ Logger.h/cpp
    â””â”€â”€ ConfigManager.h
```

---

## å››ã€ä½ ç°æœ‰æ¨¡å—çš„é‡æ„å»å‘ï¼ˆé€ä¸€å¯¹ç…§ï¼‰

### ContextManager

**ç°çŠ¶é—®é¢˜**ï¼š

- æ—¢ç®¡ tokenï¼Œåˆç®¡â€œè¯¥ä¸è¯¥è¯»æ–‡ä»¶â€

**é‡æ„å»ºè®®**ï¼š

- âŒ ä¸å†å‚ä¸â€œå†³ç­–â€
- âœ… åªåšï¼š
  - ä¸Šä¸‹æ–‡è£å‰ª
  - ä¼˜å…ˆçº§æ’åº
  - token é¢„ç®—æ‰§è¡Œ

---

### LLMClient

**å¿…é¡»çº¯ç²¹åŒ–**ï¼š

```cpp
string call(const Prompt& prompt);
```

âŒ ä¸çŸ¥é“ï¼š

- å·¥å…·
- MCP
- Skill
- é¡¹ç›®ç»“æ„

---

### SkillManager

**è§’è‰²è½¬å˜**ï¼š

ä»ï¼š

> â€œå¸®ä½ å¹²æ´»â€

å˜ä¸ºï¼š

> â€œå¸®ä½ æƒ³è¯¥è°ƒç”¨å“ªäº› Toolâ€

Skill = Tool è°ƒç”¨æ¨¡æ¿ + çº¦æŸ

---

### MCP

**å®šä½æ˜ç¡®**ï¼š

MCP â‰  Agent  
MCP = Tool Provider

ç»Ÿä¸€é€šè¿‡ ToolRegistry æš´éœ²

---

## äº”ã€å·¥ä¸šçº§å¿…é¡»è¡¥çš„ä¸‰ä»¶äº‹ï¼ˆéå¸¸å…³é”®ï¼‰

### 1ï¸âƒ£ Agent Runtimeï¼ˆä½ ç°åœ¨æ²¡æœ‰ï¼‰

å¿…é¡»å­˜åœ¨ä¸€ä¸ªå¾ªç¯ï¼š

```txt
User Goal
 â†’ Plan (LLM)
 â†’ Tool Call
 â†’ Observation
 â†’ Update State
 â†’ Continue / Finish
```

è¿™æ˜¯ä»ã€Œç©å…·ã€åˆ°ã€Œå·¥ä¸šçº§ã€çš„åˆ†æ°´å²­ã€‚

---

### 2ï¸âƒ£ å¤±è´¥è®°å¿†ï¼ˆé˜²åæ‰§ã€é˜²é‡å¤çŠ¯é”™ï¼‰

å¿…é¡»è®°å½•ï¼š

- é”™è¯¯åŸå› 
- å¤±è´¥å·¥å…·å‚æ•°
- æˆåŠŸä¿®å¤æ–¹å¼

å¦åˆ™æ™ºèƒ½ä½“ä¸€å®šä¼šâ€œè½´â€ã€‚

---

### 3ï¸âƒ£ ç¯å¢ƒè‡ªå‘ç°ï¼ˆEnvironment Awarenessï¼‰

å¯åŠ¨æ—¶è‡ªåŠ¨æ¢æµ‹ï¼š

- æ˜¯å¦å­˜åœ¨ clang / cmake / make
- é¡¹ç›®è¯­è¨€
- ç¼–è¯‘æ–¹å¼

å¹¶å†™å…¥ **ProjectMemory**ï¼Œè€Œä¸æ˜¯ä¸Šä¸‹æ–‡ã€‚

---

## å…­ã€é‡æ„æ‰§è¡Œé¡ºåºï¼ˆå¼ºçƒˆå»ºè®®ï¼‰

1. æå– AgentRuntimeï¼ˆä¸æ”¹ä¸šåŠ¡ï¼‰
2. ToolRegistry æŠ½è±¡
3. ContextManager ç˜¦èº«
4. å¼•å…¥ MemoryManagerï¼ˆå“ªæ€•å…ˆæ˜¯ JSONï¼‰
5. Skill â†’ Tool Plan åŒ–
6. MCP ç»Ÿä¸€ Tool åŒ–

---

## ä¸ƒã€ä¸€å¥ç»“è®ºï¼ˆç»™ä½ ï¼‰

> ä½ ç°åœ¨çš„é¡¹ç›®ï¼Œ**ä¸æ˜¯æ¨å€’é‡æ¥å‹é‡æ„**ï¼Œ  
> è€Œæ˜¯ **â€œæŠ½å‡ºå¤§è„‘ï¼Œæ‹‰ç›´ç¥ç»ï¼Œæ”¶ç´§è®°å¿†â€**ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ï¼š

- æŒ‰ä½ å½“å‰ä»£ç  **é€æ–‡ä»¶ç»™ä½ æ”¹é€ å»ºè®®**
- æˆ–ç›´æ¥ç»™ä½  **AgentRuntime.h çš„å·¥ä¸šçº§å®ç°éª¨æ¶**
